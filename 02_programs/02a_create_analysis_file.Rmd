---
title: "02a_create_analysis_file"
author: "Adelaide Currin, Haowei Wang, Jennah Gosciak, Yiping Zuo"
date: "2023-02-06"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(zoo)
library(DescTools)
```

# Load Data

```{r, include=F}
# download data
ar_oz <- read_csv("../00_data/ar_oz.csv")
cp_oz <- read_csv("../00_data/cp_oz.csv")

ar_oz %>%
  head()
```

```{r}
# load varlist
acs_varlist <- readxl::read_excel("../00_data/acs_varlist.xlsx") %>%
  filter(include == 1)
acs_varlist

acs_vars <- acs_varlist$variable
names(acs_vars) <- acs_varlist$description

constructs <- c("pct_white", "pct_higher_ed", "pct_rent", "pct_native_hc_covered", "pct_poverty", "minutes_commute_avg")
urbanvars <- c("dec_score", "SE_Flag", "vacancyrate", "pctunder18", "pctover64")
```

```{r}
# attempt at adjusted differences for arrests
ar_oz2 <- ar_oz %>%
  mutate(quarter = case_when(
    arrest_date >= mdy("06-01-2018") & arrest_date < mdy("09-01-2018") ~ 1,
    arrest_date >= mdy("09-01-2018") & arrest_date < mdy("12-01-2018") ~ 2,
    arrest_date >= mdy("12-01-2018") & arrest_date < mdy("3-01-2019") ~ 3,
    arrest_date >= mdy("3-01-2018") & arrest_date < mdy("6-01-2019") ~ 4,
    arrest_date >= mdy("6-01-2018") & arrest_date < mdy("9-01-2019") ~ 5,
    arrest_date >= mdy("9-01-2018") & arrest_date < mdy("12-01-2019") ~ 6,
    arrest_date >= mdy("12-01-2019") & arrest_date < mdy("3-01-2020") ~ 7,
    arrest_date >= mdy("3-01-2018") & arrest_date < mdy("6-01-2020") ~ 8,
    arrest_date >= mdy("6-01-2018") & arrest_date < mdy("9-01-2020") ~ 9,
    arrest_date >= mdy("9-01-2020") & arrest_date < mdy("12-01-2020") ~ 10
  )) %>%
  mutate(
    treatment = if_else(DESIGNATED == T, 1, 0),
    distance_boundary = if_else(DESIGNATED == F, distance_boundary * -1, distance_boundary)
  ) %>%
  filter(!is.na(DESIGNATED) & buffer == 1) %>%
  # note: calculating this at the Census block level
  mutate(post = if_else(arrest_date >= mdy("04-01-2018"), 1, 0)) %>%
  group_by(
    GEOID_b, GEOID, post, quarter, DESIGNATED, pct_white, pct_higher_ed, pct_rent, pct_native_hc_covered,
    pct_poverty, minutes_commute_avg, dec_score, SE_Flag, vacancyrate, pctunder18, pctover64, buffer
  ) %>%
  rename(violent_ellen_ar = violent_ellen,
       property_ellen_ar = property_ellen,
       distance_boundary_ar = distance_boundary) %>% 
  summarize(
    violent_ellen_ar = sum(violent_ellen_ar, na.rm = T),
    property_ellen_ar = sum(property_ellen_ar, na.rm = T),
    distance_boundary_ar = mean(distance_boundary_ar, na.rm = T)
  ) %>%
  mutate(SE_Flag = if_else(is.na(SE_Flag), 0, SE_Flag)) %>%
  filter(post == 1 & !is.na(quarter))
  
stopifnot(eeptools::isid(ar_oz2, c("GEOID_b", "post", "quarter")))

```

```{r}
# attempt at adjusted differences for complaints
cp_oz2 <- cp_oz %>%
  mutate(quarter = case_when(
    cmplnt_fr_dt >= mdy("06-01-2018") & cmplnt_fr_dt < mdy("09-01-2018") ~ 1,
    cmplnt_fr_dt >= mdy("09-01-2018") & cmplnt_fr_dt < mdy("12-01-2018") ~ 2,
    cmplnt_fr_dt >= mdy("12-01-2018") & cmplnt_fr_dt < mdy("3-01-2019") ~ 3,
    cmplnt_fr_dt >= mdy("3-01-2018") & cmplnt_fr_dt < mdy("6-01-2019") ~ 4,
    cmplnt_fr_dt >= mdy("6-01-2018") & cmplnt_fr_dt < mdy("9-01-2019") ~ 5,
    cmplnt_fr_dt >= mdy("9-01-2018") & cmplnt_fr_dt < mdy("12-01-2019") ~ 6,
    cmplnt_fr_dt >= mdy("12-01-2019") & cmplnt_fr_dt < mdy("3-01-2020") ~ 7,
    cmplnt_fr_dt >= mdy("3-01-2018") & cmplnt_fr_dt < mdy("6-01-2020") ~ 8,
    cmplnt_fr_dt >= mdy("6-01-2018") & cmplnt_fr_dt < mdy("9-01-2020") ~ 9,
    cmplnt_fr_dt >= mdy("9-01-2020") & cmplnt_fr_dt < mdy("12-01-2020") ~ 10
  )) %>%
  mutate(
    treatment = if_else(DESIGNATED == T, 1, 0),
    distance_boundary = if_else(DESIGNATED == F, distance_boundary * -1, distance_boundary)
  ) %>%
  filter(!is.na(DESIGNATED) & buffer == 1) %>%
  # note: calculating this at the Census block level
  mutate(post = if_else(cmplnt_fr_dt >= mdy("04-01-2018"), 1, 0)) %>%
  group_by(
    GEOID_b, GEOID, post, quarter, DESIGNATED, pct_white, pct_higher_ed, pct_rent, pct_native_hc_covered,
    pct_poverty, minutes_commute_avg, dec_score, SE_Flag, vacancyrate, pctunder18, pctover64, buffer
  ) %>%
  rename(violent_ellen_cp = violent_ellen,
     property_ellen_cp = property_ellen,
     distance_boundary_cp = distance_boundary) %>%
  summarize(
    violent_ellen_cp = sum(violent_ellen_cp, na.rm = T),
    property_ellen_cp = sum(property_ellen_cp, na.rm = T),
    distance_boundary_cp = mean(distance_boundary_cp, na.rm = T)
  ) %>%
  mutate(SE_Flag = if_else(is.na(SE_Flag), 0, SE_Flag)) %>%
  filter(post == 1 & !is.na(quarter))

stopifnot(eeptools::isid(cp_oz2, c("GEOID_b", "post", "quarter")))

# when write methods section, cite paper
```

```{r}
# Winsorize
ar_oz2 <- ar_oz2 %>%
  mutate(
    violent_ellen_winsorize_ar = Winsorize(violent_ellen_ar, probs = c(0.01, 0.99)),
    property_ellen_winsorize_ar = Winsorize(property_ellen_ar, probs = c(0.01, 0.99))
  ) %>%
  mutate(across(starts_with("violent_ellen_ar"), ~ if_else(is.na(.), 0, .))) %>%
  mutate(across(starts_with("property_ellen_ar"), ~ if_else(is.na(.), 0, .)))

cp_oz2 <- cp_oz2 %>%
  mutate(
    violent_ellen_winsorize_cp = Winsorize(violent_ellen_cp, probs = c(0.01, 0.99)),
    property_ellen_winsorize_cp = Winsorize(property_ellen_cp, probs = c(0.01, 0.99))
  ) %>%
  mutate(across(starts_with("violent_ellen_cp"), ~ if_else(is.na(.), 0, .))) %>%
  mutate(across(starts_with("property_ellen_cp"), ~ if_else(is.na(.), 0, .)))
```


```{r}
# Create one file
ar_oz3 <- ar_oz2 %>% ungroup()
cp_oz3 <- cp_oz2 %>% ungroup()

analysis_file <- left_join(cp_oz3, ar_oz3 %>% 
                          select(GEOID_b, quarter, violent_ellen_ar, violent_ellen_winsorize_ar,
                                 property_ellen_ar, property_ellen_winsorize_ar, 
                                 distance_boundary_ar), 
                           by = c("GEOID_b" = "GEOID_b", "quarter" = "quarter")) %>%
              arrange(quarter) %>% 
              pivot_wider(names_from = quarter,
              values_from = c(violent_ellen_ar, violent_ellen_winsorize_ar, property_ellen_ar,
                              property_ellen_winsorize_ar, distance_boundary_ar,
                              violent_ellen_cp, violent_ellen_winsorize_cp, property_ellen_cp,
                              property_ellen_winsorize_cp, distance_boundary_cp))

```

```{r}
# write to csv

analysis_file %>%
  write_csv("../00_data/analysis_file.csv")

```





