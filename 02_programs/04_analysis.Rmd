---
title: "Report Figures"
author: "Adelaide Currin, Haowei Wang, Jennah Gosciak, Yiping Zuo"
date: "2023-01-23"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(zoo)
library(lmtest)
library(sandwich)
library(wesanderson)
library(rdrobust)
library(stargazer)
library(modelsummary)
library(kableExtra)
library(gt)

EXCLUDE_INELIGIBLE <- FALSE
file_suffix <- "_keep_ineligible"
```

# Load Data

```{r, include=F}
# download data
analysis_file <- read_csv("../00_data/analysis_file.csv")

if (EXCLUDE_INELIGIBLE == T) {
  analysis_file <- analysis_file %>%
    filter(status != "Ineligible")
  file_suffix <- NULL
}

analysis_file %>%
  head()
```
```{r}
# load varlist
acs_varlist <- readxl::read_excel("../00_data/acs_varlist.xlsx") %>%
  filter(include == 1)
acs_varlist

acs_vars <- acs_varlist$variable
names(acs_vars) <- acs_varlist$description

constructs <- c("population", "median_earnings", "median_household_income", "median_gross_rent",
                "pct_white", "pct_higher_ed", "pct_rent", "pct_native_hc_covered", "pct_poverty", "minutes_commute_avg",
                "dec_score", "SE_Flag", "vacancyrate", "pctunder18", "pctover64")

```

```{r}
tidy.rdrobust <- function(outcome, x, outcome_name, p = 1, covs = NULL, ...) {
  if (!is.null(covs)) {
    object <- rdrobust(outcome, x,
      c = 0, covs = covs,
      masspoints = "adjust", p = p,
      ...
    )

    covariate_lab <- "covariates"
  } else {
    object <- rdrobust(outcome, x,
      c = 0,
      masspoints = "adjust", p = p,
      ...
    )

    covariate_lab <- "no covariates"
  }

  ret <- data.frame(
    outcome = outcome_name,
    term = row.names(object$coef),
    order = p,
    covs = covariate_lab,
    estimate = object$coef[, 1],
    std.error = object$se[, 1],
    statistic = object$z[, 1],
    p.value = object$pv[, 1],
    conf.low = object$ci[, 1],
    conf.high = object$ci[, 2],
    nobs.left = object$N[1],
    nobs.right = object$N[2],
    nobs.effective.left = object$N_h[1],
    nobs.effective.right = object$N_h[2],
    cutoff = object$c,
    order.regression = object$q,
    order.bias = object$q,
    kernel = object$kernel,
    bwselect = object$bwselect,
    bandwidth.h = str_c("[", object$bws[1, 1], ",", object$bws[1, 2], "]"),
    bandwidth.b = str_c("[", object$bws[2, 1], ",", object$bws[2, 2], "]")
  )
  row.names(ret) <- NULL
  ret
}
```

```{r}
run_baseline_checks <- function(outcome_data, running_var, outcomes, p, bandwidth) {
  # vector to drop missing covariates
  not_na_rows <- outcome_data %>%
    is.na() %>%
    rowSums() %>%
    magrittr::equals(0)

  # drop missing covariate values
  outcome_data_cov <- outcome_data[not_na_rows, ]
  running_var_cov <- running_var[not_na_rows]

  return(map2_dfr(
    outcome_data, outcomes,
    ~ tidy.rdrobust(.x, running_var, .y, p = p, h = bandwidth, b = bandwidth)
  ))
}

run_model_set <- function(outcome_data, running_var, outcomes, p, covs) {
  # vector to drop missing covariates
  keep_cov <- covs %>%
    is.na() %>%
    rowSums() %>%
    magrittr::equals(0)

  # drop missing covariate values
  outcome_data_cov <- outcome_data[keep_cov, ]
  running_var_cov <- running_var[keep_cov]
  covs <- covs[keep_cov, ]

  return(map2_dfr(
    outcome_data, outcomes,
    ~ tidy.rdrobust(.x, running_var, .y, p = p)
  ) %>%
    bind_rows(map2_dfr(
      outcome_data_cov, outcomes,
      ~ tidy.rdrobust(.x, running_var_cov, .y, p = p, covs = covs)
    )))
}
```

```{r}
# define data and outcomes
outcomes_ar <- map(
  c("violent_ellen_winsorize_ar_", "property_ellen_winsorize_ar_"),
  ~ str_c(., c("min4", "min3", "min1", 0, c(1:7)))
) %>%
  unlist()
outcome_data_ar <- analysis_file[, outcomes_ar]
running_var <- analysis_file[["centroid_distance_boundary"]]
covariates <- analysis_file[, constructs]

outcomes_cp <- map(c("violent_ellen_winsorize_cp_", "property_ellen_winsorize_cp_"), ~ str_c(., c("min4", "min3", "min1", 0, c(1:7))) ) %>%
  unlist()
outcome_data_cp <- analysis_file[, outcomes_cp]
```

```{r}
# balance test data
balance_data <- analysis_file[, constructs]
bequiv <- map_dfr(
  cross2(c(1:4), seq(100, 1000, 100)),
  ~ run_baseline_checks(balance_data, running_var, constructs, p = .[[1]], bandwidth = .[[2]])
) %>%
  arrange(outcome, term, order, covs)

bequiv %>% 
  mutate(estimate_form= case_when(p.value < 0.01 ~ paste0(round(estimate, 2), "***"),
                                  p.value < 0.05 ~ paste0(round(estimate, 2), "**"),
                                  p.value < 0.1 ~ paste0(round(estimate, 2), "*"),
                                  TRUE ~ paste0(round(estimate, 2))),
         coef_form = str_c(estimate_form, "\n(", round(std.error, 2),")")) %>% 
  pivot_wider(id_cols = c("outcome", "covs", "bandwidth.h"), names_from = c("term", "order"),
              values_from = "coef_form") %>%
  select(c("outcome", "covs", "bandwidth.h"), matches("Conventional"), matches("Bias")) %>% 
  mutate(outcome = factor(outcome, levels = constructs, ordered = T)) %>% 
  arrange( covs, bandwidth.h, outcome) %>%
  write_csv(str_glue("../03_output/baseline_form_{Sys.Date()}{file_suffix}.csv"))

bequiv %>% 
  distinct(outcome)
bequiv %>%
  write_csv(str_glue("../03_output/baseline_{Sys.Date()}{file_suffix}.csv"))

constructs
```


```{r}
output <- map_dfr(
  c(1,4),
  ~ run_model_set(outcome_data_ar, running_var, outcomes_ar, p = ., covariates)
) %>%
  bind_rows(map_dfr(
    c(1,4),
    ~ run_model_set(outcome_data_cp, running_var, outcomes_cp, p = ., covariates)
  ))

output <- output %>%
  separate(outcome, c("crime_type", "measurement", "winsorize", "arrest_or_complaint", "quarter")) %>%
  select(-c(measurement)) %>%
  select(crime_type, arrest_or_complaint, winsorize, term, order, covs, quarter, everything()) %>%
  arrange(crime_type, arrest_or_complaint, term, order, covs, quarter)

output %>%
  write_csv(str_glue("../03_output/results_{Sys.Date()}{file_suffix}.csv"))


output %>% 
  filter(winsorize == "winsorize") %>% 
  mutate(nobs = rowSums(select(., c(nobs.left, nobs.right)), na.rm = T)) %>% 
  distinct(nobs, covs, crime_type)

output %>% 
  filter(winsorize == "winsorize") %>% 
  mutate(estimate_form= case_when(p.value < 0.01 ~ paste0(round(estimate, 2), "***"),
                                  p.value < 0.05 ~ paste0(round(estimate, 2), "**"),
                                  p.value < 0.1 ~ paste0(round(estimate, 2), "*"),
                                  TRUE ~ paste0(round(estimate, 2))),
         coef_form = str_c(estimate_form, "\n(", round(std.error, 2),")")) %>% 
  pivot_wider(id_cols = c("quarter", "order", "covs"), names_from = c("crime_type", "term", "arrest_or_complaint"),
              values_from = "coef_form") %>%
  select(c("quarter", "order", "covs"), matches("Conventional"), matches("Bias")) %>% 
  write_csv(str_glue("../03_output/results_form_{Sys.Date()}{file_suffix}.csv"))
```

```{r}
# creating plots
walk(c(1,4), ~ rdplot(outcome_data_ar[[1]], running_var,
  p = ., title = str_glue("RD Plot for p={.}"),
  x.label = "distance", y.label = outcomes[1]
))

# walk(c(1:4), ~ rdplot(outcome_data_ar[[1]], running_var_ar[[1]], p = ., covs = covs_ar, title = str_glue("RD Plot w/ covariates for p={.}"), x.label = "distance", y.label = outcomes[1]))
```

```{r}
plot_data <- analysis_file %>%
  select(c(GEOID_b, status, centroid_distance_boundary, matches("violent_ellen_winsorize"))) %>%
  pivot_longer(matches("violent_ellen_winsorize")) %>%
  separate(name, c("crime_type", "method", "winsorize", "ar_cp", "quarter")) %>%
  filter(ar_cp == "ar") %>%
  mutate(treatment = if_else(status == "Selected", 1, 0))

plot_data %>%
  filter(abs(centroid_distance_boundary) < 193) %>%
  ggplot(aes(x = centroid_distance_boundary, y = value, group = status, color = status)) +
  geom_point(alpha = 0.25) +
  # geom_smooth(method="lm") +
  theme_classic() +
  facet_wrap(~quarter)
```
```{r}
points <- analysis_file %>%
  filter(abs(centroid_distance_boundary) < 193) %>%
  mutate(centroid_distance_boundary = round(centroid_distance_boundary, 1)) %>%
  group_by(centroid_distance_boundary) %>%
  summarize(across(matches("violent_ellen_winsorize"), ~ mean(., na.rm = T))) %>%
  pivot_longer(-centroid_distance_boundary)

points
```

```{r}
plot_data %>%
  filter(abs(centroid_distance_boundary) < 193) %>%
  ggplot(aes(x = centroid_distance_boundary, y = value, color = status)) +
  geom_point(data = points, aes(x = centroid_distance_boundary, y = value), alpha = .2, inherit.aes = F) +
  geom_smooth(method = "lm") +
  theme_classic() +
  facet_wrap(~quarter)
```









