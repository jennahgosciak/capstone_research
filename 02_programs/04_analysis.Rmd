---
title: "Report Figures"
author: "Adelaide Currin, Haowei Wang, Jennah Gosciak, Yiping Zuo"
date: "2023-01-23"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(zoo)
library("lmtest")
library("sandwich")
library("wesanderson")
library("SpatialRDD")
library("rdrobust")
library(stargazer)
```

# Load Data

```{r, include=F}
# download data
ar_oz <- read_csv("../00_data/ar_oz.csv")
cp_oz <- read_csv("../00_data/cp_oz.csv")
st_oz <- read_csv("../00_data/st_oz.csv")

ar_oz %>%
  head()
```
```{r}
# load varlist
acs_varlist <- readxl::read_excel("../00_data/acs_varlist.xlsx") %>%
  filter(include == 1)
acs_varlist

acs_vars <- acs_varlist$variable
names(acs_vars) <- acs_varlist$description

constructs <- c("pct_white", "pct_higher_ed", "pct_rent", "pct_native_hc_covered", "pct_poverty", "minutes_commute_avg")
urbanvars <- c("dec_score", "SE_Flag", "vacancyrate", "pctunder18", "pctover64")

oz_bound <- st_read("../00_data/oz_bound.geojson")
oz <- st_read("../00_data/nyc_oz.geojson")

oz_treat <- oz %>% 
  filter(DESIGNATED == "True")

cb <- st_read("https://data.cityofnewyork.us/resource/twhy-dzjp.geojson?$limit=1000000") %>%
  st_transform(2263)

cb_adj <- st_read("../00_data/cb_adjacent.geojson")
cb_adj
```

```{r}
# attempt at adjusted differences for arrests
ar_oz2 <- ar_oz %>%
  mutate(arrest_month_yr = as.Date(
    str_c(month(arrest_date), 1, year(arrest_date), sep = "-"),
    "%m-%d-%Y"
  )) %>%
  mutate(year = year(arrest_month_yr),
         treatment = if_else(DESIGNATED == T, 1, 0),
         distance_boundary = if_else(DESIGNATED == F, distance_boundary * -1, distance_boundary)) %>%
  # note: calculating this at the Census block level
  group_by(
    GEOID_b, arrest_month_yr, DESIGNATED, pct_white, pct_higher_ed, pct_rent, pct_native_hc_covered,
    pct_poverty, minutes_commute_avg, dec_score, SE_Flag, vacancyrate, pctunder18, pctover64, buffer
  ) %>%
  summarize(violent_ellen = sum(violent_ellen, na.rm = T),
            property_ellen = sum(property_ellen, na.rm = T),
            distance_boundary = round(mean(distance_boundary, na.rm = T))) %>%
  filter(!is.na(DESIGNATED) & buffer == 1) %>%
  mutate(SE_Flag = if_else(is.na(SE_Flag), 0, SE_Flag))
```

```{r}
# bws <- rdbwselect(ar_oz2$violent_ellen, ar_oz2$distance_boundary, p=1, c = 0,
#                   kernel = "tri", bwselect="mserd")

summary(rdrobust(ar_oz2$violent_ellen, ar_oz2$distance_boundary, c = 0))
```






